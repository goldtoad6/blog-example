pipeline {
    agent any

    environment {
        NVD_API_KEY = credentials('nvd-api-key')
        SONAR_TOKEN = credentials('sonar-token')
        DOCKER_REGISTRY = 'registry.company.com'
        APP_NAME = 'e-shop'
    }

    tools {
        maven 'maven-3.9'
        nodejs 'nodejs-20'
        dependencyCheck 'dependency-check'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 30, unit: 'MINUTES')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                sh 'git log --oneline -5'
            }
        }

        stage('Backend Build & Test') {
            steps {
                dir('backend') {
                    sh 'mvn clean compile test'
                }
            }
            post {
                always {
                    dir('backend') {
                        junit 'target/surefire-reports/*.xml'
                    }
                }
            }
        }

        stage('Frontend Build & Test') {
            steps {
                dir('frontend') {
                    sh 'npm ci'
                    sh 'npm run build'
                    sh 'npm test'
                }
            }
        }

        stage('Security Scans') {
            parallel {
                stage('Backend Dependency-Check') {
                    steps {
                        dir('backend') {
                            sh 'mvn dependency-check:check'
                        }
                    }
                    post {
                        always {
                            dir('backend') {
                                dependencyCheckPublisher pattern: 'target/dependency-check-report.xml'
                                archiveArtifacts artifacts: 'target/dependency-check-report.*', allowEmptyArchive: true
                            }
                        }
                    }
                }

                stage('Frontend Dependency-Check') {
                    steps {
                        dir('frontend') {
                            dependencyCheck additionalArguments: """
                                --project "E-Shop-Frontend"
                                --scan package.json
                                --scan package-lock.json
                                --format HTML
                                --format XML
                                --format JSON
                                --failOnCVSS 7
                                --nvdApiKey ${NVD_API_KEY}
                                --out reports
                                --enableExperimental
                            """,
                            odcInstallation: 'dependency-check'
                        }
                    }
                    post {
                        always {
                            dir('frontend') {
                                dependencyCheckPublisher pattern: 'reports/dependency-check-report.xml'
                                archiveArtifacts artifacts: 'reports/dependency-check-report.*', allowEmptyArchive: true
                            }
                        }
                    }
                }

                stage('SonarQube Analysis') {
                    steps {
                        dir('backend') {
                            withSonarQubeEnv('SonarQube') {
                                sh """
                                    mvn sonar:sonar \
                                        -Dsonar.projectKey=e-shop-backend \
                                        -Dsonar.projectName="E-Shop Backend" \
                                        -Dsonar.dependencyCheck.reportPath=target/dependency-check-report.xml
                                """
                            }
                        }
                    }
                }

                stage('npm Audit') {
                    steps {
                        dir('frontend') {
                            sh 'npm audit --audit-level=moderate'
                        }
                    }
                }
            }
        }

        stage('Security Gate') {
            steps {
                script {
                    def backendReport = readJSON file: 'backend/target/dependency-check-report.json'
                    def frontendReport = readJSON file: 'frontend/reports/dependency-check-report.json'

                    def backendVulns = backendReport.dependencies.collectMany { it.vulnerabilities ?: [] }
                    def frontendVulns = frontendReport.dependencies.collectMany { it.vulnerabilities ?: [] }

                    def allVulns = backendVulns + frontendVulns

                    def critical = allVulns.count { it.cvssv3?.baseScore >= 9.0 }
                    def high = allVulns.count { it.cvssv3?.baseScore >= 7.0 && it.cvssv3?.baseScore < 9.0 }
                    def medium = allVulns.count { it.cvssv3?.baseScore >= 4.0 && it.cvssv3?.baseScore < 7.0 }

                    echo "ğŸ”’ ä¾èµ–æ‰«æç»“æœæ±‡æ€»ï¼š"
                    echo "   ä¸¥é‡: ${critical}"
                    echo "   é«˜å±: ${high}"
                    echo "   ä¸­å±: ${medium}"

                    if (critical > 0) {
                        error "âŒ å‘ç° ${critical} ä¸ªä¸¥é‡æ¼æ´ï¼Œé˜»å¡å‘å¸ƒï¼è¯·ç«‹å³ä¿®å¤ã€‚"
                    }

                    if (high > 3) {
                        input message: "å‘ç° ${high} ä¸ªé«˜å±æ¼æ´ï¼Œæ˜¯å¦ç»§ç»­éƒ¨ç½²ï¼Ÿ",
                              ok: 'ç¡®è®¤éƒ¨ç½²',
                              submitter: 'security-team,devops-team'
                    }

                    if (medium > 20) {
                        unstable "âš ï¸ ä¸­å±æ¼æ´æ•°é‡è¾ƒå¤šï¼ˆ${medium}ä¸ªï¼‰ï¼Œå»ºè®®å®‰æ’ä¿®å¤è®¡åˆ’"
                    }

                    echo "âœ… å®‰å…¨é—¨ç¦é€šè¿‡"
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                script {
                    def version = sh(script: 'git describe --tags --always', returnStdout: true).trim()
                    env.IMAGE_TAG = version

                    dir('backend') {
                        sh """
                            docker build \
                                -t ${DOCKER_REGISTRY}/${APP_NAME}-backend:${version} \
                                -t ${DOCKER_REGISTRY}/${APP_NAME}-backend:latest \
                                .
                        """
                    }

                    dir('frontend') {
                        sh """
                            docker build \
                                -t ${DOCKER_REGISTRY}/${APP_NAME}-frontend:${version} \
                                -t ${DOCKER_REGISTRY}/${APP_NAME}-frontend:latest \
                                .
                        """
                    }
                }
            }
        }

        stage('Container Security Scan') {
            steps {
                script {
                    sh """
                        trivy image \
                            --severity HIGH,CRITICAL \
                            --exit-code 1 \
                            ${DOCKER_REGISTRY}/${APP_NAME}-backend:${IMAGE_TAG}
                    """

                    sh """
                        trivy image \
                            --severity HIGH,CRITICAL \
                            --exit-code 1 \
                            ${DOCKER_REGISTRY}/${APP_NAME}-frontend:${IMAGE_TAG}
                    """
                }
            }
        }

        stage('Push Images') {
            when {
                anyOf {
                    branch 'main'
                    branch 'release/*'
                }
            }
            steps {
                script {
                    sh """
                        docker push ${DOCKER_REGISTRY}/${APP_NAME}-backend:${IMAGE_TAG}
                        docker push ${DOCKER_REGISTRY}/${APP_NAME}-backend:latest
                        docker push ${DOCKER_REGISTRY}/${APP_NAME}-frontend:${IMAGE_TAG}
                        docker push ${DOCKER_REGISTRY}/${APP_NAME}-frontend:latest
                    """
                }
            }
        }

        stage('Deploy to Test') {
            when {
                branch 'develop'
            }
            steps {
                sh '''
                    kubectl set image deployment/e-shop-backend \
                        backend=${DOCKER_REGISTRY}/${APP_NAME}-backend:${IMAGE_TAG} \
                        -n test
                    kubectl rollout status deployment/e-shop-backend -n test
                '''
            }
        }
    }

    post {
        always {
            script {
                def summary = """
## æ„å»ºæŠ¥å‘Š

- **é¡¹ç›®**: ${env.JOB_NAME}
- **æ„å»ºå·**: ${env.BUILD_NUMBER}
- **åˆ†æ”¯**: ${env.BRANCH_NAME}
- **æäº¤**: ${env.GIT_COMMIT?.take(8)}

### æ„å»ºç»“æœ: ${currentBuild.currentResult}

è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹ï¼š${env.BUILD_URL}
"""
                echo summary
            }

            cleanWs()
        }

        failure {
            emailext (
                subject: "âŒ æ„å»ºå¤±è´¥: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """æ„å»ºå¤±è´¥ï¼Œå¯èƒ½å‘ç°å®‰å…¨é—®é¢˜ã€‚

é¡¹ç›®: ${env.JOB_NAME}
åˆ†æ”¯: ${env.BRANCH_NAME}
æ„å»ºå·: ${env.BUILD_NUMBER}

æŸ¥çœ‹è¯¦æƒ…: ${env.BUILD_URL}

è¯·æ£€æŸ¥ Dependency-Check æŠ¥å‘Šã€‚""",
                to: "${env.CHANGE_AUTHOR_EMAIL ?: 'dev-team@company.com'}",
                recipientProviders: [developers(), requestor()]
            )
        }

        unstable {
            emailext (
                subject: "âš ï¸ æ„å»ºä¸ç¨³å®š: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """å‘ç°å®‰å…¨é—®é¢˜ï¼Œéœ€è¦å…³æ³¨ã€‚

æŸ¥çœ‹è¯¦æƒ…: ${env.BUILD_URL}""",
                to: "security-team@company.com"
            )
        }
    }
}
